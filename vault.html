<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Vault | Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Nunito:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css?v=5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div id="toast-container" class="vault-toast">
        <div class="toast-icon"><i class="fas fa-check"></i></div>
        <span style="color:var(--cream-text); font-size:0.9rem;">Changes published to live site.</span>
    </div>

    <div class="container" style="padding-top: 50px;">
        <div class="vault-container">
            <!-- Header -->
            <div class="vault-header">
                <i class="fas fa-lock vault-icon"></i>
                <div>
                    <h1 style="margin:0; font-size:2rem;">The Vault</h1>
                    <p style="color:var(--sage-soft); margin:5px 0 0 0; font-size:0.9rem;">Magical Inventory Control</p>
                </div>
            </div>

            <div id="loading" style="color:var(--lilac-light); text-align:center; padding:40px;">
                <i class="fas fa-spinner fa-spin"></i> Descanting scrolls...
            </div>

            <div id="stock-inputs" style="display:none;">
                <!-- Generated by JS -->
            </div>

        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="saveChanges()" id="save-btn" class="vault-fab">
        <i class="fas fa-magic"></i> Update Shop Status
    </button>

    <!-- SCRIPTS -->
    <script src="assets/js/data.js"></script>
    <script src="assets/js/stock-manager.js"></script>
    <script>
        // Init
        const container = document.getElementById('stock-inputs');
        const loader = document.getElementById('loading');
        const saveBtn = document.getElementById('save-btn');
        const toast = document.getElementById('toast-container');

        // Check if running on Server (No-DB Mode Active: Checks disabled)
        // if (window.location.protocol === 'file:') { ... }

        // Load Data
        (async function init() {
            // 1. Sync local PRODUCTS with Server/Local Data
            await StockManager.syncProducts();

            // 2. Render Inputs
            loader.style.display = 'none';
            container.style.display = 'block';
            saveBtn.style.display = 'flex'; // Ensure flex for icon+text

            PRODUCTS.forEach(p => {
                const isOpen = p.stock > 0;

                // Explicit Image Mapping per User Request
                let imgPath = 'assets/images/paperback.png'; // Default
                if (p.id.includes('hb') || p.format.toLowerCase().includes('hardbound')) {
                    imgPath = 'assets/images/hardbound.png';
                } else if (p.id === 'her-stories-pdf') {
                    imgPath = 'assets/images/btc2.png';
                }

                const div = document.createElement('div');
                div.className = 'inventory-shelf';
                div.innerHTML = `
                    <div class="shelf-book-info">
                        <img src="${imgPath}" class="shelf-thumb" alt="${p.title}" onerror="this.src='https://via.placeholder.com/60x80/2A2438/B5A8D1?text=Book'">
                        <div>
                            <span class="shelf-title">${p.title}</span>
                            <span class="shelf-meta">${p.format} â€¢ ${p.isPreOrder ? 'Pre-Order Item' : 'Standard Item'}</span>
                        </div>
                    </div>
                    
                    <div class="vault-toggle-group">
                        <span id="label-${p.id}" class="vault-status-label" style="color:${isOpen ? 'var(--sage-soft)' : '#E26D6D'}">
                            ${isOpen ? (p.id === 'her-stories-pdf' ? 'Available' : 'Pre-order Active') : 'Unavailable'}
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="toggle-${p.id}" ${isOpen ? 'checked' : ''} onchange="updateLabel('${p.id}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        })();

        function updateLabel(id) {
            const el = document.getElementById(`toggle-${id}`);
            const label = document.getElementById(`label-${id}`);
            const isDigital = id === 'her-stories-pdf';

            if (el.checked) {
                label.innerText = isDigital ? "Available" : "Pre-order Active";
                label.style.color = "var(--sage-soft)";
            } else {
                label.innerText = "Unavailable";
                label.style.color = "#E26D6D";
            }
        }

        async function saveChanges() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Casting...`;

            // Collect Data
            const newStock = {};
            PRODUCTS.forEach(p => {
                const isOpen = document.getElementById(`toggle-${p.id}`).checked;
                // LOGIC: If Open -> 200 Stock, If Closed -> 0 Stock
                const val = isOpen ? 200 : 0;
                newStock[p.id] = val;
                p.stock = val; // Update local memory too
            });

            // Send to Manager
            const result = await StockManager.saveStock(newStock);

            if (result.success) {
                showToast();
            } else {
                alert(`Error: ${result.message}`);
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        }

        function showToast() {
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>